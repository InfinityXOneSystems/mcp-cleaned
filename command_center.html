<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Command Center</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; }
        body {
            background: #05060b;
            color: #f5f7fb;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            font-size: 13px;
            line-height: 1.5;
            overflow: hidden;
        }

        .page {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #05060b;
        }

        .tabs {
            display: flex;
            gap: 2px;
            padding: 16px 20px 0 20px;
            background: rgba(12, 14, 22, 0.55);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }
        .tab {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
            padding: 10px 20px;
            color: #9aa2b8;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
        }
        .tab:hover { background: rgba(255, 255, 255, 0.08); color: #d7dbea; }
        .tab.active { background: rgba(31, 107, 255, 0.2); border-color: rgba(31, 107, 255, 0.5); color: #f5f7fb; }

        .section { display: none; flex: 1; overflow: hidden; }
        .section.active { display: flex; }

        /* Trading layout */
        .trading-shell {
            <script>
                const CHAT_ENDPOINT = 'http://localhost:8001/api/chat';
                const PORTFOLIO_ENDPOINT = 'http://localhost:8001/api/portfolio';
                const INTEL_BASE = 'http://localhost:8002';
                let perfChart = null;
                let allocChart = null;
                let currentSources = [];
                let selectedSourceId = null;

                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(tab.dataset.tab).classList.add('active');
                    });
                });

                // Trading functions
                function initCharts() {
                    const perfCtx = document.getElementById('performanceChart').getContext('2d');
                    perfChart = new Chart(perfCtx, {
                        type: 'line',
                        data: {
                            labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Today'],
                            datasets: [{
                                label: 'Portfolio',
                                data: [5000, 5120, 5080, 5250, 5180, 5340],
                                borderColor: '#5078b4',
                                backgroundColor: 'rgba(80, 120, 180, 0.03)',
                                borderWidth: 1.5,
                                fill: true,
                                tension: 0.3,
                                pointRadius: 3,
                                pointBackgroundColor: '#5078b4',
                                pointBorderColor: '#0a0e27',
                                pointBorderWidth: 1,
                                pointHoverRadius: 4,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { grid: { color: 'rgba(255, 255, 255, 0.02)', drawBorder: false }, ticks: { color: '#8b92a9', font: { size: 10 } } },
                                x: { grid: { display: false }, ticks: { color: '#8b92a9', font: { size: 10 } } }
                            }
                        }
                    });

                    const allocCtx = document.getElementById('allocationChart').getContext('2d');
                    allocChart = new Chart(allocCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Crypto', 'Stocks', 'Commodities', 'Indices', 'Forex', 'Cash'],
                            datasets: [{
                                data: [25, 28, 18, 12, 5, 12],
                                backgroundColor: [
                                    'rgba(80, 120, 180, 0.7)',
                                    'rgba(100, 140, 200, 0.7)',
                                    'rgba(60, 100, 160, 0.7)',
                                    'rgba(120, 160, 220, 0.7)',
                                    'rgba(70, 110, 170, 0.7)',
                                    'rgba(40, 60, 100, 0.7)'
                                ],
                                borderColor: '#0a0e27',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'bottom', labels: { color: '#8b92a9', font: { size: 10 }, padding: 8, usePointStyle: true } } }
                        }
                    });
                }

                async function loadData() {
                    try {
                        const res = await fetch(PORTFOLIO_ENDPOINT);
                        const data = await res.json();
                        const val = data.total_value.toFixed(2);
                        const ret = data.total_pnl_pct;
                        const pnl = data.total_pnl;
                        document.getElementById('headerValue').textContent = `$${val}`;
                        document.getElementById('statValue').textContent = `$${Math.round(data.total_value).toLocaleString()}`;
                        const returnEl = document.getElementById('headerReturn');
                        returnEl.textContent = `${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%`;
                        returnEl.className = `metric-value ${ret >= 0 ? 'positive' : 'negative'}`;
                        const pnlEl = document.getElementById('statPnL');
                        pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${Math.round(pnl).toLocaleString()}`;
                        pnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;
                        document.getElementById('headerPositions').textContent = data.num_positions;
                        document.getElementById('statPositions').textContent = data.num_positions;
                        const tbody = document.getElementById('positionsTable');
                        if (data.positions.length === 0) {
                            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No open positions</td></tr>';
                        } else {
                            tbody.innerHTML = data.positions.map(p => `
                                <tr>
                                    <td>${p.asset}</td>
                                    <td>${p.direction}</td>
                                    <td>$${p.entry_price.toFixed(2)}</td>
                                    <td>$${p.current_price.toFixed(2)}</td>
                                    <td>${p.quantity.toFixed(4)}</td>
                                    <td>$${p.entry_value.toFixed(0)}</td>
                                    <td>$${p.current_value.toFixed(0)}</td>
                                    <td class="${p.pnl >= 0 ? 'positive' : 'negative'}">${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(0)}</td>
                                    <td class="${p.pnl_pct >= 0 ? 'positive' : 'negative'}">${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%</td>
                                </tr>
                            `).join('');
                        }
                    } catch (e) { console.error('Error loading data:', e); }
                }

                async function sendMessage() {
                    const input = document.getElementById('chatInput');
                    const msg = input.value.trim();
                    if (!msg) return;
                    input.value = '';
                    try {
                        await fetch(CHAT_ENDPOINT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ role: 'user', text: msg }) });
                        await fetchChat();
                    } catch (err) { console.error('Chat send failed', err); }
                }

                async function fetchChat() {
                    try {
                        const res = await fetch(CHAT_ENDPOINT);
                        const data = await res.json();
                        renderChat(data.messages || []);
                    } catch (err) { console.error('Chat fetch failed', err); }
                }

                function renderChat(messages) {
                    const box = document.getElementById('chatMessages');
                    box.innerHTML = '';
                    messages.forEach(m => {
                        const roleClass = m.role === 'user' ? 'user' : 'system';
                        const el = document.createElement('div');
                        el.className = `message ${roleClass}`;
                        el.innerHTML = `<div class="message-bubble">${m.text}</div>`;
                        box.appendChild(el);
                    });
                    box.scrollTop = box.scrollHeight;
                }

                function setMode(ev, mode) {
                    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                    ev.target.classList.add('active');
                    const box = document.getElementById('chatMessages');
                    const el = document.createElement('div');
                    el.className = 'message system';
                    el.innerHTML = `<div class="message-bubble">Switched to ${mode} mode.</div>`;
                    box.appendChild(el);
                    box.scrollTop = box.scrollHeight;
                }

                // Intelligence functions
                async function loadCategories() {
                    try {
                        const res = await fetch(`${INTEL_BASE}/api/intelligence/categories`);
                        const categories = await res.json();
                        const categorySelect = document.getElementById('categorySelect');
                        categorySelect.innerHTML = '<option value="">All Categories</option>';
                        for (const [category, subcats] of Object.entries(categories)) {
                            const total = Object.values(subcats).reduce((sum, count) => sum + count, 0);
                            const opt = document.createElement('option');
                            opt.value = category; opt.textContent = `${category} (${total})`;
                            categorySelect.appendChild(opt);
                        }
                        categorySelect.onchange = () => { loadSubcategories(categories); loadSources(); };
                        loadSubcategories(categories);
                    } catch (err) { console.error('Failed to load categories', err); }
                }

                function loadSubcategories(categories) {
                    const category = document.getElementById('categorySelect').value;
                    const subcategorySelect = document.getElementById('subcategorySelect');
                    subcategorySelect.innerHTML = '<option value="">All Sub-Industries</option>';
                    if (category && categories[category]) {
                        for (const [subcat, count] of Object.entries(categories[category])) {
                            const opt = document.createElement('option');
                            opt.value = subcat; opt.textContent = `${subcat} (${count})`;
                            subcategorySelect.appendChild(opt);
                        }
                    }
                }

                async function loadSources() {
                    const category = document.getElementById('categorySelect').value;
                    const subcategory = document.getElementById('subcategorySelect').value;
                    const search = document.getElementById('searchInput').value;
                    try {
                        const params = new URLSearchParams();
                        if (category) params.append('category', category);
                        if (subcategory) params.append('subcategory', subcategory);
                        if (search) params.append('search', search);
                        const res = await fetch(`${INTEL_BASE}/api/intelligence/sources?${params}`);
                        const data = await res.json();
                        currentSources = data.sources || [];
                        document.getElementById('sourceCount').textContent = data.count;
                        const list = document.getElementById('sourcesList');
                        if (currentSources.length === 0) {
                            list.innerHTML = '<div style="text-align: center; padding: 40px; color: #9aa2b8;">No sources found</div>';
                            return;
                        }
                        list.innerHTML = currentSources.map(source => `
                            <div class="source-item" data-id="${source.id}" onclick="selectSource(event, ${source.id})">
                                <div class="source-url">${source.url}</div>
                                <div class="source-key">${source.key}</div>
                            </div>
                        `).join('');
                    } catch (err) { console.error('Failed to load sources', err); }
                }

                async function selectSource(ev, id) {
                    selectedSourceId = id;
                    document.querySelectorAll('.source-item').forEach(el => el.classList.remove('active'));
                    const target = ev.currentTarget || ev.target.closest('.source-item');
                    if (target) target.classList.add('active');
                    try {
                        const res = await fetch(`${INTEL_BASE}/api/intelligence/preview/${id}`);
                        const data = await res.json();
                        const content = document.querySelector('.preview-content');
                        content.innerHTML = `
                            <div class="preview-data">
                                <div style="margin-bottom: 12px;"><strong>ID:</strong> ${data.id}<br><strong>Key:</strong> ${data.key}</div>
                                <div style="margin-bottom: 8px;"><strong>Raw Data:</strong></div>
                                <pre>${JSON.stringify(data.data, null, 2)}</pre>
                            </div>
                        `;
                    } catch (err) { console.error('Failed to load preview', err); }
                }

                function scheduleModal() {
                    alert('Schedule crawl feature coming soon! Set recurring crawls per category.');
                }

                document.addEventListener('DOMContentLoaded', () => {
                    initCharts();
                    loadData();
                    setInterval(loadData, 10000);
                    document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
                    fetchChat();
                    setInterval(fetchChat, 5000);
                    loadCategories();
                    loadSources();
                    document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') loadSources(); });
                });
            </script>
            loadCategories();
            loadSources();
            document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') loadSources(); });
        });
    </script>
</body>
</html>
    <div class="workspace">
        <div class="tabs">
            <a href="http://localhost:8001/command_center.html" class="tab active">Trading Dashboard</a>
            <a href="http://localhost:8002/" class="tab">Intelligence Browser</a>
            <a href="#" class="tab" onclick="alert('Coming soon: Prediction Analytics'); return false;">Predictions</a>
            <a href="#" class="tab" onclick="alert('Coming soon: Portfolio Analysis'); return false;">Portfolio</a>
        </div>

        <!-- CHAT SIDEBAR -->
        <div class="sidebar">
            <div class="chat-header">
                <div class="chat-label">Intelligence Feed</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message system">
                    <div class="message-bubble">System online. Ready for commands.</div>
                </div>
            </div>
            <div class="chat-input-wrapper">
                <input 
                    type="text" 
                    class="chat-input" 
                    id="chatInput" 
                    placeholder="Query trades, analysis, predictions..."
                    autocomplete="off"
                >
                <button class="send-btn" onclick="sendMessage()">Send</button>
            </div>
        </div>

        <!-- MAIN DASHBOARD -->
        <div class="main-content">
            <div class="dashboard-header">
                <div class="header-left">
                    <div class="header-title">Trading Dashboard</div>
                    <div class="metrics-row">
                        <div class="metric">
                            <div class="metric-label">Portfolio Value</div>
                            <div class="metric-value" id="headerValue">$5,000.00</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Total Return</div>
                            <div class="metric-value positive" id="headerReturn">+0.00%</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Active Positions</div>
                            <div class="metric-value" id="headerPositions">21</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Win Rate</div>
                            <div class="metric-value" id="headerWinRate">0.0%</div>
                        </div>
                    </div>
                </div>
                <div class="mode-controls">
                    <button class="mode-btn active" onclick="setMode('auto')">Auto</button>
                    <button class="mode-btn" onclick="setMode('hybrid')">Hybrid</button>
                    <button class="mode-btn" onclick="setMode('manual')">Manual</button>
                </div>
            </div>

            <div class="analytics">
                <!-- Key Stats -->
                <div class="card">
                    <div class="card-title">Account Value</div>
                    <div class="card-content">
                        <div class="stat-block">
                            <div class="stat-value" id="statValue">$5,000</div>
                            <div class="stat-desc">Current Holdings</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Profit/Loss</div>
                    <div class="card-content">
                        <div class="stat-block">
                            <div class="stat-value positive" id="statPnL">+$0</div>
                            <div class="stat-desc">Net Gain/Loss</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">Open Positions</div>
                    <div class="card-content">
                        <div class="stat-block">
                            <div class="stat-value" id="statPositions">21</div>
                            <div class="stat-desc">Active Trades</div>
                        </div>
                    </div>
                </div>

                <!-- Performance Chart -->
                <div class="card span2">
                    <div class="card-title">Performance Trajectory</div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Allocation Chart -->
                <div class="card">
                    <div class="card-title">Asset Allocation</div>
                    <div class="card-content">
                        <div class="chart-container">
                            <canvas id="allocationChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Positions Table -->
                <div class="card span3">
                    <div class="card-title">Open Positions</div>
                    <div class="card-content">
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Direction</th>
                                        <th>Entry</th>
                                        <th>Current</th>
                                        <th>Qty</th>
                                        <th>Entry Value</th>
                                        <th>Current Value</th>
                                        <th>P/L</th>
                                        <th>Return</th>
                                    </tr>
                                </thead>
                                <tbody id="positionsTable">
                                    <tr><td colspan="9" style="text-align: center; padding: 20px;">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let perfChart = null;
        let allocChart = null;
        const CHAT_ENDPOINT = 'http://localhost:8001/api/chat';

        function initCharts() {
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            perfChart = new Chart(perfCtx, {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Today'],
                    datasets: [{
                        label: 'Portfolio',
                        data: [5000, 5120, 5080, 5250, 5180, 5340],
                        borderColor: '#5078b4',
                        backgroundColor: 'rgba(80, 120, 180, 0.03)',
                        borderWidth: 1.5,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointBackgroundColor: '#5078b4',
                        pointBorderColor: '#0a0e27',
                        pointBorderWidth: 1,
                        pointHoverRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255, 255, 255, 0.02)', drawBorder: false },
                            ticks: { color: '#8b92a9', font: { size: 10 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#8b92a9', font: { size: 10 } }
                        }
                    }
                }
            });

            const allocCtx = document.getElementById('allocationChart').getContext('2d');
            allocChart = new Chart(allocCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Crypto', 'Stocks', 'Commodities', 'Indices', 'Forex', 'Cash'],
                    datasets: [{
                        data: [25, 28, 18, 12, 5, 12],
                        backgroundColor: [
                            'rgba(80, 120, 180, 0.7)',
                            'rgba(100, 140, 200, 0.7)',
                            'rgba(60, 100, 160, 0.7)',
                            'rgba(120, 160, 220, 0.7)',
                            'rgba(70, 110, 170, 0.7)',
                            'rgba(40, 60, 100, 0.7)'
                        ],
                        borderColor: '#0a0e27',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#8b92a9', font: { size: 10 }, padding: 8, usePointStyle: true }
                        }
                    }
                }
            });
        }

        async function loadData() {
            try {
                const res = await fetch('http://localhost:8001/api/portfolio');
                const data = await res.json();

                const val = data.total_value.toFixed(2);
                const ret = data.total_pnl_pct;
                const pnl = data.total_pnl;

                document.getElementById('headerValue').textContent = `$${val}`;
                document.getElementById('statValue').textContent = `$${Math.round(data.total_value).toLocaleString()}`;

                const returnEl = document.getElementById('headerReturn');
                returnEl.textContent = `${ret >= 0 ? '+' : ''}${ret.toFixed(2)}%`;
                returnEl.className = `metric-value ${ret >= 0 ? 'positive' : 'negative'}`;

                const pnlEl = document.getElementById('statPnL');
                pnlEl.textContent = `${pnl >= 0 ? '+' : ''}$${Math.round(pnl).toLocaleString()}`;
                pnlEl.className = `stat-value ${pnl >= 0 ? 'positive' : 'negative'}`;

                document.getElementById('headerPositions').textContent = data.num_positions;
                document.getElementById('statPositions').textContent = data.num_positions;

                const tbody = document.getElementById('positionsTable');
                if (data.positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">No open positions</td></tr>';
                } else {
                    tbody.innerHTML = data.positions.map(p => `
                        <tr>
                            <td>${p.asset}</td>
                            <td>${p.direction}</td>
                            <td>$${p.entry_price.toFixed(2)}</td>
                            <td>$${p.current_price.toFixed(2)}</td>
                            <td>${p.quantity.toFixed(4)}</td>
                            <td>$${p.entry_value.toFixed(0)}</td>
                            <td>$${p.current_value.toFixed(0)}</td>
                            <td class="${p.pnl >= 0 ? 'positive' : 'negative'}">${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(0)}</td>
                            <td class="${p.pnl_pct >= 0 ? 'positive' : 'negative'}">${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(1)}%</td>
                        </tr>
                    `).join('');
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            input.value = '';
            try {
                await fetch(CHAT_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role: 'user', text: msg })
                });
                await fetchChat();
            } catch (err) {
                console.error('Chat send failed', err);
            }
        }

        async function fetchChat() {
            try {
                const res = await fetch(CHAT_ENDPOINT);
                const data = await res.json();
                renderChat(data.messages || []);
            } catch (err) {
                console.error('Chat fetch failed', err);
            }
        }

        function renderChat(messages) {
            const box = document.getElementById('chatMessages');
            box.innerHTML = '';
            messages.forEach(m => {
                const roleClass = m.role === 'user' ? 'user' : 'system';
                const el = document.createElement('div');
                el.className = `message ${roleClass}`;
                el.innerHTML = `<div class="message-bubble">${m.text}</div>`;
                box.appendChild(el);
            });
            box.scrollTop = box.scrollHeight;
        }

        function setMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            addMsg(`Switched to ${mode} mode.`, 'system');
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            loadData();
            setInterval(loadData, 10000);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            fetchChat();
            setInterval(fetchChat, 5000);
        });
    </script>
</body>
</html>
