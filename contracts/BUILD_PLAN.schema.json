{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "MCP Build Plan Schema",
    "description": "Machine-readable schema for Auto Builder build plans. CI-enforced.",
    "type": "object",
    "required": [
        "plan_id",
        "requested_by",
        "intent_summary",
        "governance_level",
        "scope",
        "architecture",
        "steps",
        "constraints",
        "risk_assessment",
        "validation_requirements",
        "artifacts"
    ],
    "properties": {
        "plan_id": {
            "type": "string",
            "pattern": "^[A-Z]{2,4}-[A-Z]{2,4}-[0-9]{4}-[0-9]{2}-[0-9]{2}-[0-9]{3}$",
            "description": "Unique build plan identifier (e.g., VC-AB-2025-12-26-001)"
        },
        "requested_by": {
            "type": "string",
            "enum": [
                "VisionCortex"
            ],
            "description": "Only VisionCortex may request builds"
        },
        "intent_summary": {
            "type": "string",
            "minLength": 20,
            "maxLength": 500,
            "description": "Clear description of what is being built and why"
        },
        "governance_level": {
            "type": "string",
            "enum": [
                "LOW",
                "MEDIUM",
                "HIGH",
                "CRITICAL"
            ],
            "description": "Required governance level for this build"
        },
        "scope": {
            "type": "object",
            "required": [
                "write_paths",
                "read_paths"
            ],
            "properties": {
                "write_paths": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "pattern": "^/mcp/(vision_cortex|auto_builder|validator|contracts)/.*$"
                    },
                    "description": "Paths that will be modified (must be in authorized list)"
                },
                "read_paths": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Paths that will be read (no restrictions)"
                }
            }
        },
        "architecture": {
            "type": "object",
            "required": [
                "components",
                "interfaces"
            ],
            "properties": {
                "components": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "minItems": 1,
                    "description": "List of components being created/modified"
                },
                "interfaces": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "Interfaces that components must implement"
                }
            }
        },
        "steps": {
            "type": "array",
            "minItems": 1,
            "items": {
                "type": "object",
                "required": [
                    "step_id",
                    "description",
                    "action",
                    "files"
                ],
                "properties": {
                    "step_id": {
                        "type": "string",
                        "pattern": "^S[0-9]{2}$",
                        "description": "Step identifier (S01, S02, etc.)"
                    },
                    "description": {
                        "type": "string",
                        "minLength": 10,
                        "description": "What this step accomplishes"
                    },
                    "action": {
                        "type": "string",
                        "enum": [
                            "create",
                            "modify",
                            "delete"
                        ],
                        "description": "Type of file operation"
                    },
                    "files": {
                        "type": "array",
                        "items": {
                            "type": "string",
                            "pattern": "^/mcp/(vision_cortex|auto_builder|validator|contracts)/.*$"
                        },
                        "minItems": 1,
                        "description": "Files affected by this step"
                    },
                    "dependencies": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        },
                        "description": "Step IDs that must complete before this step"
                    },
                    "validation_gate": {
                        "type": "string",
                        "description": "Validation gate ID that must pass before this step"
                    }
                }
            }
        },
        "constraints": {
            "type": "array",
            "items": {
                "type": "string"
            },
            "minItems": 1,
            "description": "Hard constraints that must not be violated"
        },
        "risk_assessment": {
            "type": "string",
            "minLength": 20,
            "description": "Assessment of risks and mitigations"
        },
        "validation_requirements": {
            "type": "array",
            "items": {
                "type": "string"
            },
            "minItems": 1,
            "description": "Checks that must pass for build to succeed"
        },
        "artifacts": {
            "type": "array",
            "items": {
                "type": "string",
                "enum": [
                    "build_plan.json",
                    "execution_log.json",
                    "diff_manifest.json",
                    "validation_report.json"
                ]
            },
            "minItems": 4,
            "maxItems": 4,
            "uniqueItems": true,
            "description": "All four artifacts are mandatory"
        },
        "memory_model": {
            "type": "object",
            "properties": {
                "backend": {
                    "type": "string",
                    "enum": [
                        "Firestore",
                        "InMemory"
                    ]
                },
                "collection": {
                    "type": "string"
                },
                "schema": {
                    "type": "object"
                }
            },
            "description": "Memory persistence configuration"
        },
        "communication_model": {
            "type": "object",
            "properties": {
                "transport": {
                    "type": "string",
                    "enum": [
                        "PubSub",
                        "Direct"
                    ]
                },
                "channels": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "message_schema": {
                    "type": "object"
                }
            },
            "description": "Inter-agent communication configuration"
        },
        "validation_gates": {
            "type": "array",
            "items": {
                "type": "object",
                "required": [
                    "gate_id",
                    "name",
                    "trigger",
                    "checks"
                ],
                "properties": {
                    "gate_id": {
                        "type": "string",
                        "pattern": "^G[0-9]{2}$"
                    },
                    "name": {
                        "type": "string"
                    },
                    "trigger": {
                        "type": "string"
                    },
                    "checks": {
                        "type": "array",
                        "items": {
                            "type": "string"
                        }
                    }
                }
            },
            "description": "Validation gates that must pass"
        },
        "risk_controls": {
            "type": "array",
            "items": {
                "type": "object",
                "required": [
                    "control",
                    "trigger",
                    "action"
                ],
                "properties": {
                    "control": {
                        "type": "string"
                    },
                    "trigger": {
                        "type": "string"
                    },
                    "action": {
                        "type": "string"
                    }
                }
            },
            "description": "Risk mitigation controls"
        },
        "integration_points": {
            "type": "array",
            "items": {
                "type": "object",
                "required": [
                    "target",
                    "type",
                    "purpose"
                ],
                "properties": {
                    "target": {
                        "type": "string"
                    },
                    "type": {
                        "type": "string",
                        "enum": [
                            "read_only",
                            "read_write"
                        ]
                    },
                    "purpose": {
                        "type": "string"
                    }
                }
            },
            "description": "External integration points"
        }
    },
    "additionalProperties": false
}